name: Update Homebrew Tap

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-homebrew-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Check tap credentials
        id: tap_creds
        env:
          HOMEBREW_TAP_PAT: ${{ secrets.HOMEBREW_TAP_PAT }}
          HOMEBREW_TAP_SSH_KEY: ${{ secrets.HOMEBREW_TAP_SSH_KEY }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${HOMEBREW_TAP_PAT:-}" || -n "${HOMEBREW_TAP_SSH_KEY:-}" ]]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "enabled=false" >> "$GITHUB_OUTPUT"
          echo "Homebrew tap credentials not configured; skipping tap update."

      - name: Checkout ButterPaper
        uses: actions/checkout@v4
        if: ${{ steps.tap_creds.outputs.enabled == 'true' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
        if: ${{ steps.tap_creds.outputs.enabled == 'true' }}

      - name: Clone homebrew tap
        env:
          HOMEBREW_TAP_PAT: ${{ secrets.HOMEBREW_TAP_PAT }}
          HOMEBREW_TAP_SSH_KEY: ${{ secrets.HOMEBREW_TAP_SSH_KEY }}
        shell: bash
        if: ${{ steps.tap_creds.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail

          if [[ -n "${HOMEBREW_TAP_PAT:-}" ]]; then
            git clone "https://x-access-token:${HOMEBREW_TAP_PAT}@github.com/apotenza92/homebrew-tap.git" /tmp/homebrew-tap
            exit 0
          fi

          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"
          printf '%s\n' "$HOMEBREW_TAP_SSH_KEY" > "$HOME/.ssh/id_ed25519"
          chmod 600 "$HOME/.ssh/id_ed25519"
          ssh-keyscan github.com >> "$HOME/.ssh/known_hosts"

          git clone "git@github.com:apotenza92/homebrew-tap.git" /tmp/homebrew-tap

      - name: Update casks from release data
        if: ${{ steps.tap_creds.outputs.enabled == 'true' }}
        run: |
          python3 scripts/release/update_homebrew_tap_casks.py --tap-path /tmp/homebrew-tap

      - name: Commit and push changes
        if: ${{ steps.tap_creds.outputs.enabled == 'true' }}
        run: |
          cd /tmp/homebrew-tap
          if git diff --quiet -- Casks/butterpaper.rb Casks/butterpaper@beta.rb; then
            echo "No cask changes to push."
            exit 0
          fi

          git config user.name "butterpaper-release-bot"
          git config user.email "actions@users.noreply.github.com"

          git add Casks/butterpaper.rb Casks/butterpaper@beta.rb
          git commit -m "Update ButterPaper casks from release metadata"
          git push origin main
