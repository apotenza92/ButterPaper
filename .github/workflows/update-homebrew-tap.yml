name: Update Homebrew Tap

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-homebrew-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ButterPaper
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Fail if tap credentials are missing
        if: ${{ secrets.HOMEBREW_TAP_PAT == '' && secrets.HOMEBREW_TAP_SSH_KEY == '' }}
        run: |
          echo "::error::Missing tap credentials. Set HOMEBREW_TAP_PAT or HOMEBREW_TAP_SSH_KEY in repo secrets."
          exit 1

      - name: Start ssh-agent (deploy key)
        if: ${{ secrets.HOMEBREW_TAP_SSH_KEY != '' && secrets.HOMEBREW_TAP_PAT == '' }}
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HOMEBREW_TAP_SSH_KEY }}

      - name: Clone homebrew tap (PAT)
        if: ${{ secrets.HOMEBREW_TAP_PAT != '' }}
        env:
          HOMEBREW_TAP_PAT: ${{ secrets.HOMEBREW_TAP_PAT }}
        run: |
          git clone "https://x-access-token:${HOMEBREW_TAP_PAT}@github.com/apotenza92/homebrew-tap.git" /tmp/homebrew-tap

      - name: Clone homebrew tap (SSH deploy key)
        if: ${{ secrets.HOMEBREW_TAP_PAT == '' && secrets.HOMEBREW_TAP_SSH_KEY != '' }}
        run: |
          git clone "git@github.com:apotenza92/homebrew-tap.git" /tmp/homebrew-tap

      - name: Update casks from release data
        run: |
          python3 scripts/release/update_homebrew_tap_casks.py --tap-path /tmp/homebrew-tap

      - name: Commit and push changes
        run: |
          cd /tmp/homebrew-tap
          if git diff --quiet -- Casks/butterpaper.rb Casks/butterpaper@beta.rb; then
            echo "No cask changes to push."
            exit 0
          fi

          git config user.name "butterpaper-release-bot"
          git config user.email "actions@users.noreply.github.com"

          git add Casks/butterpaper.rb Casks/butterpaper@beta.rb
          git commit -m "Update ButterPaper casks from release metadata"
          git push origin main
