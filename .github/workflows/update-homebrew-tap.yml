name: Update Homebrew Tap

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-homebrew-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ButterPaper
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Clone homebrew tap
        env:
          HOMEBREW_TAP_PAT: ${{ secrets.HOMEBREW_TAP_PAT }}
        run: |
          test -n "$HOMEBREW_TAP_PAT"
          git clone "https://x-access-token:${HOMEBREW_TAP_PAT}@github.com/apotenza92/homebrew-tap.git" /tmp/homebrew-tap

      - name: Update casks from release data
        run: |
          python3 scripts/release/update_homebrew_tap_casks.py --tap-path /tmp/homebrew-tap

      - name: Commit and push changes
        env:
          HOMEBREW_TAP_PAT: ${{ secrets.HOMEBREW_TAP_PAT }}
        run: |
          cd /tmp/homebrew-tap
          if git diff --quiet -- Casks/butterpaper.rb Casks/butterpaper@beta.rb; then
            echo "No cask changes to push."
            exit 0
          fi

          git config user.name "butterpaper-release-bot"
          git config user.email "actions@users.noreply.github.com"

          git add Casks/butterpaper.rb Casks/butterpaper@beta.rb
          git commit -m "Update ButterPaper casks from release metadata"
          git push origin main
